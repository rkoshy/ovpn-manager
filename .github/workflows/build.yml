# GitHub Actions CI/CD Pipeline for OpenVPN3 Manager
# Builds for Debian 12 (Bookworm) and Debian 13 (Trixie)

name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  #
  # Debian 12 (Bookworm) Builds
  #

  build-debian12:
    name: Build - Debian 12
    runs-on: ubuntu-latest
    container:
      image: debian:12

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          echo "Installing build dependencies for Debian 12"
          apt-get update -qq
          apt-get install -y -qq \
            build-essential \
            pkg-config \
            python3 \
            python3-pip \
            ninja-build \
            libglib2.0-dev \
            libsystemd-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libcairo2-dev \
            openvpn3
          pip3 install --quiet --break-system-packages meson
          echo "Dependency installation complete"

      - name: Verify GTK and GLib versions
        run: |
          echo "Verifying GTK version..."
          pkg-config --modversion gtk+-3.0
          echo "Verifying GLib version..."
          pkg-config --modversion glib-2.0

      - name: Configure build
        run: |
          echo "===== Building for Debian 12 (Bookworm) ====="
          echo "Configuring build with Meson..."
          meson setup builddir --buildtype=release --prefix=/usr
          echo "Meson configuration summary:"
          meson configure builddir

      - name: Build
        run: |
          echo "Building with Ninja..."
          ninja -C builddir -v
          echo "Stripping binary..."
          strip builddir/src/ovpn-manager
          echo "Build complete!"
          ls -lh builddir/src/ovpn-manager

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ovpn-manager-debian12-${{ github.sha }}
          path: |
            builddir/src/ovpn-manager
            builddir/meson-logs/
          retention-days: 7

  test-debian12:
    name: Test - Debian 12
    runs-on: ubuntu-latest
    container:
      image: debian:12
    needs: build-debian12

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install runtime dependencies
        run: |
          apt-get update -qq
          apt-get install -y -qq \
            file \
            libglib2.0-0 \
            libgtk-3-0 \
            libsystemd0 \
            libayatana-appindicator3-1 \
            libcairo2 \
            openvpn3

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ovpn-manager-debian12-${{ github.sha }}
          path: builddir/

      - name: Make binary executable
        run: chmod +x builddir/src/ovpn-manager

      - name: Run tests
        run: |
          echo "===== Testing Debian 12 build ====="
          echo "Verifying binary exists and is executable..."
          test -f builddir/src/ovpn-manager
          test -x builddir/src/ovpn-manager

          echo "Checking binary type..."
          file builddir/src/ovpn-manager

          echo "Checking dynamic dependencies..."
          ldd builddir/src/ovpn-manager || true

          echo "Getting binary size..."
          ls -lh builddir/src/ovpn-manager

          echo "Checking for required symbols..."
          nm builddir/src/ovpn-manager | grep -E "(gtk_init|g_main_loop|sd_bus)" || true

          echo "Running basic smoke test (--help)..."
          timeout 2 builddir/src/ovpn-manager --help || echo "No --help option implemented (expected)"

          echo "Running binary with 3-second timeout (will fail if no display, expected)..."
          timeout 3 builddir/src/ovpn-manager 2>&1 | tee test-output.log || true

          echo "Checking for critical errors in output..."
          if grep -i "critical\|segfault\|abort" test-output.log; then
            echo "FAIL - Critical errors found in output"
            exit 1
          fi

          echo "Test suite passed!"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-debian12-${{ github.sha }}
          path: test-output.log
          retention-days: 7

  #
  # Debian 13 (Trixie/Testing) Builds
  #

  build-debian13:
    name: Build - Debian 13
    runs-on: ubuntu-latest
    container:
      image: debian:trixie

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          echo "Installing build dependencies for Debian 13"
          apt-get update -qq
          apt-get install -y -qq \
            build-essential \
            pkg-config \
            python3 \
            python3-pip \
            ninja-build \
            libglib2.0-dev \
            libsystemd-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libcairo2-dev \
            openvpn3
          pip3 install --quiet --break-system-packages meson
          echo "Dependency installation complete"

      - name: Verify GTK and GLib versions
        run: |
          echo "Verifying GTK version..."
          pkg-config --modversion gtk+-3.0
          echo "Verifying GLib version..."
          pkg-config --modversion glib-2.0

      - name: Configure build
        run: |
          echo "===== Building for Debian 13 (Trixie) ====="
          echo "Configuring build with Meson..."
          meson setup builddir --buildtype=release --prefix=/usr
          echo "Meson configuration summary:"
          meson configure builddir

      - name: Build
        run: |
          echo "Building with Ninja..."
          ninja -C builddir -v
          echo "Stripping binary..."
          strip builddir/src/ovpn-manager
          echo "Build complete!"
          ls -lh builddir/src/ovpn-manager

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ovpn-manager-debian13-${{ github.sha }}
          path: |
            builddir/src/ovpn-manager
            builddir/meson-logs/
          retention-days: 7

  test-debian13:
    name: Test - Debian 13
    runs-on: ubuntu-latest
    container:
      image: debian:trixie
    needs: build-debian13

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install runtime dependencies
        run: |
          apt-get update -qq
          apt-get install -y -qq \
            file \
            libglib2.0-0 \
            libgtk-3-0 \
            libsystemd0 \
            libayatana-appindicator3-1 \
            libcairo2 \
            openvpn3

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ovpn-manager-debian13-${{ github.sha }}
          path: builddir/

      - name: Make binary executable
        run: chmod +x builddir/src/ovpn-manager

      - name: Run tests
        run: |
          echo "===== Testing Debian 13 build ====="
          echo "Verifying binary exists and is executable..."
          test -f builddir/src/ovpn-manager
          test -x builddir/src/ovpn-manager

          echo "Checking binary type..."
          file builddir/src/ovpn-manager

          echo "Checking dynamic dependencies..."
          ldd builddir/src/ovpn-manager || true

          echo "Getting binary size..."
          ls -lh builddir/src/ovpn-manager

          echo "Checking for required symbols..."
          nm builddir/src/ovpn-manager | grep -E "(gtk_init|g_main_loop|sd_bus)" || true

          echo "Running basic smoke test (--help)..."
          timeout 2 builddir/src/ovpn-manager --help || echo "No --help option implemented (expected)"

          echo "Running binary with 3-second timeout (will fail if no display, expected)..."
          timeout 3 builddir/src/ovpn-manager 2>&1 | tee test-output.log || true

          echo "Checking for critical errors in output..."
          if grep -i "critical\|segfault\|abort" test-output.log; then
            echo "FAIL - Critical errors found in output"
            exit 1
          fi

          echo "Test suite passed!"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-debian13-${{ github.sha }}
          path: test-output.log
          retention-days: 7

  #
  # Optional: Debug builds (run manually)
  #

  build-debian12-debug:
    name: Build - Debian 12 (Debug)
    runs-on: ubuntu-latest
    container:
      image: debian:12
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update -qq
          apt-get install -y -qq \
            build-essential \
            pkg-config \
            python3 \
            python3-pip \
            ninja-build \
            libglib2.0-dev \
            libsystemd-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libcairo2-dev \
            openvpn3
          pip3 install --quiet --break-system-packages meson

      - name: Build debug version
        run: |
          echo "===== Building DEBUG version for Debian 12 ====="
          meson setup builddir --buildtype=debug --prefix=/usr
          ninja -C builddir -v
          echo "Debug build complete (not stripped)!"
          ls -lh builddir/src/ovpn-manager

      - name: Upload debug artifact
        uses: actions/upload-artifact@v4
        with:
          name: ovpn-manager-debian12-debug-${{ github.sha }}
          path: |
            builddir/src/ovpn-manager
            builddir/meson-logs/
          retention-days: 3

  build-debian13-debug:
    name: Build - Debian 13 (Debug)
    runs-on: ubuntu-latest
    container:
      image: debian:trixie
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update -qq
          apt-get install -y -qq \
            build-essential \
            pkg-config \
            python3 \
            python3-pip \
            ninja-build \
            libglib2.0-dev \
            libsystemd-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libcairo2-dev \
            openvpn3
          pip3 install --quiet --break-system-packages meson

      - name: Build debug version
        run: |
          echo "===== Building DEBUG version for Debian 13 ====="
          meson setup builddir --buildtype=debug --prefix=/usr
          ninja -C builddir -v
          echo "Debug build complete (not stripped)!"
          ls -lh builddir/src/ovpn-manager

      - name: Upload debug artifact
        uses: actions/upload-artifact@v4
        with:
          name: ovpn-manager-debian13-debug-${{ github.sha }}
          path: |
            builddir/src/ovpn-manager
            builddir/meson-logs/
          retention-days: 3

  #
  # Optional: Create .deb packages (run manually)
  #

  package-debian12:
    name: Package - Debian 12
    runs-on: ubuntu-latest
    container:
      image: debian:12
    needs: build-debian12
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install packaging tools
        run: |
          apt-get update -qq
          apt-get install -y -qq dpkg-dev fakeroot

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ovpn-manager-debian12-${{ github.sha }}
          path: builddir/

      - name: Make binary executable
        run: chmod +x builddir/src/ovpn-manager

      - name: Create .deb package
        run: |
          echo "===== Creating .deb package for Debian 12 ====="
          mkdir -p debian-package/DEBIAN
          mkdir -p debian-package/usr/bin
          mkdir -p debian-package/etc/xdg/autostart
          cp builddir/src/ovpn-manager debian-package/usr/bin/
          cp data/ovpn-manager.desktop debian-package/etc/xdg/autostart/

          cat > debian-package/DEBIAN/control <<EOF
          Package: ovpn-manager
          Version: 0.1.0-${GITHUB_SHA::7}
          Section: net
          Priority: optional
          Architecture: amd64
          Depends: libglib2.0-0, libgtk-3-0, libsystemd0, libayatana-appindicator3-1, libcairo2, openvpn3
          Maintainer: Renny Koshy
          Description: Professional GTK3-based VPN client for OpenVPN3
           Lightweight, event-driven VPN manager with real-time monitoring,
           server selection, and advanced features for power users.
          EOF

          cat debian-package/DEBIAN/control
          fakeroot dpkg-deb --build debian-package
          mv debian-package.deb ovpn-manager_0.1.0-${GITHUB_SHA::7}_debian12_amd64.deb
          dpkg-deb --info ovpn-manager_0.1.0-${GITHUB_SHA::7}_debian12_amd64.deb

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: ovpn-manager-deb-debian12-${{ github.sha }}
          path: ovpn-manager_0.1.0-*_debian12_amd64.deb
          retention-days: 30

  package-debian13:
    name: Package - Debian 13
    runs-on: ubuntu-latest
    container:
      image: debian:trixie
    needs: build-debian13
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install packaging tools
        run: |
          apt-get update -qq
          apt-get install -y -qq dpkg-dev fakeroot

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ovpn-manager-debian13-${{ github.sha }}
          path: builddir/

      - name: Make binary executable
        run: chmod +x builddir/src/ovpn-manager

      - name: Create .deb package
        run: |
          echo "===== Creating .deb package for Debian 13 ====="
          mkdir -p debian-package/DEBIAN
          mkdir -p debian-package/usr/bin
          mkdir -p debian-package/etc/xdg/autostart
          cp builddir/src/ovpn-manager debian-package/usr/bin/
          cp data/ovpn-manager.desktop debian-package/etc/xdg/autostart/

          cat > debian-package/DEBIAN/control <<EOF
          Package: ovpn-manager
          Version: 0.1.0-${GITHUB_SHA::7}
          Section: net
          Priority: optional
          Architecture: amd64
          Depends: libglib2.0-0, libgtk-3-0, libsystemd0, libayatana-appindicator3-1, libcairo2, openvpn3
          Maintainer: Renny Koshy
          Description: Professional GTK3-based VPN client for OpenVPN3
           Lightweight, event-driven VPN manager with real-time monitoring,
           server selection, and advanced features for power users.
          EOF

          cat debian-package/DEBIAN/control
          fakeroot dpkg-deb --build debian-package
          mv debian-package.deb ovpn-manager_0.1.0-${GITHUB_SHA::7}_debian13_amd64.deb
          dpkg-deb --info ovpn-manager_0.1.0-${GITHUB_SHA::7}_debian13_amd64.deb

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: ovpn-manager-deb-debian13-${{ github.sha }}
          path: ovpn-manager_0.1.0-*_debian13_amd64.deb
          retention-days: 30
