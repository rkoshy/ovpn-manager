# GitHub Actions CI/CD Pipeline for OpenVPN3 Manager
# Builds for Debian 12 (Bookworm) and Debian 13 (Trixie)
# Uses pre-built scorussolutions/gtk3-deb-builder images with all deps

name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build - Debian ${{ matrix.debian }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - debian: "12"
            image: "scorussolutions/gtk3-deb-builder-d12:latest"
          - debian: "13"
            image: "scorussolutions/gtk3-deb-builder-d13:latest"
    container:
      image: ${{ matrix.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure and build
        run: |
          meson setup builddir --buildtype=release --prefix=/usr
          ninja -C builddir
          strip builddir/src/ovpn-manager
          echo "Binary size: $(ls -lh builddir/src/ovpn-manager | awk '{print $5}')"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ovpn-manager-debian${{ matrix.debian }}-${{ github.sha }}
          path: builddir/src/ovpn-manager
          retention-days: 7

  test:
    name: Test - Debian ${{ matrix.debian }}
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        include:
          - debian: "12"
            image: "scorussolutions/gtk3-deb-builder-d12:latest"
          - debian: "13"
            image: "scorussolutions/gtk3-deb-builder-d13:latest"
    container:
      image: ${{ matrix.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ovpn-manager-debian${{ matrix.debian }}-${{ github.sha }}
          path: builddir/src/

      - name: Run tests
        run: |
          chmod +x builddir/src/ovpn-manager
          test -f builddir/src/ovpn-manager
          test -x builddir/src/ovpn-manager
          file builddir/src/ovpn-manager
          ldd builddir/src/ovpn-manager || true
          ls -lh builddir/src/ovpn-manager
          timeout 3 builddir/src/ovpn-manager 2>&1 | tee test-output.log || true
          if grep -i "critical\|segfault\|abort" test-output.log; then
            echo "FAIL - Critical errors found"
            exit 1
          fi
          echo "Tests passed"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-debian${{ matrix.debian }}-${{ github.sha }}
          path: test-output.log
          retention-days: 7
