# GitHub Actions Release Workflow for OpenVPN3 Manager
# Triggers on version tags (v*.*.*) and creates GitHub releases with .deb packages
# Uses pre-built scorussolutions/gtk3-deb-builder images with all deps

name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  APP_NAME: ovpn-manager

jobs:
  build:
    name: Build - Debian ${{ matrix.debian }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - debian: "12"
            image: "scorussolutions/gtk3-deb-builder-d12:latest"
          - debian: "13"
            image: "scorussolutions/gtk3-deb-builder-d13:latest"
    container:
      image: ${{ matrix.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Configure and build
        run: |
          meson setup builddir --buildtype=release --prefix=/usr
          ninja -C builddir
          strip builddir/src/${{ env.APP_NAME }}
          echo "Binary size: $(ls -lh builddir/src/${{ env.APP_NAME }} | awk '{print $5}')"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-debian${{ matrix.debian }}
          path: builddir/src/${{ env.APP_NAME }}
          retention-days: 1

  package:
    name: Package - Debian ${{ matrix.debian }}
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        include:
          - debian: "12"
            image: "scorussolutions/gtk3-deb-builder-d12:latest"
          - debian: "13"
            image: "scorussolutions/gtk3-deb-builder-d13:latest"
    container:
      image: ${{ matrix.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: binary-debian${{ matrix.debian }}
          path: builddir/src/

      - name: Make binary executable
        run: chmod +x builddir/src/${{ env.APP_NAME }}

      - name: Create .deb package
        run: |
          VERSION=${{ steps.version.outputs.version }}
          PACKAGE_NAME="${APP_NAME}_${VERSION}_debian${{ matrix.debian }}_amd64"

          # Create package directory structure
          PKG_DIR=$(mktemp -d)
          mkdir -p $PKG_DIR/DEBIAN
          mkdir -p $PKG_DIR/usr/bin
          mkdir -p $PKG_DIR/usr/share/applications
          mkdir -p $PKG_DIR/usr/share/icons/hicolor/scalable/apps
          mkdir -p $PKG_DIR/etc/xdg/autostart

          # Copy files with correct permissions
          cp builddir/src/${APP_NAME} $PKG_DIR/usr/bin/
          install -m 644 data/ovpn-manager.desktop $PKG_DIR/usr/share/applications/
          install -m 644 data/ovpn-manager.desktop $PKG_DIR/etc/xdg/autostart/
          install -m 644 data/icons/hicolor/scalable/apps/ovpn-manager.svg $PKG_DIR/usr/share/icons/hicolor/scalable/apps/

          # Control file
          cat > $PKG_DIR/DEBIAN/control <<EOF
          Package: ${APP_NAME}
          Version: ${VERSION}
          Section: net
          Priority: optional
          Architecture: amd64
          Depends: libglib2.0-0, libgtk-3-0, libsystemd0, libayatana-appindicator3-1, libcairo2, openvpn3
          Maintainer: Renny Koshy <renny@koshy.org>
          Homepage: https://github.com/rennykoshy/ovpn-manager
          Description: Professional GTK3-based VPN client for OpenVPN3
           Lightweight, event-driven VPN manager with real-time monitoring,
           server selection, and advanced features for power users.
          EOF
          # Remove leading whitespace from control file (heredoc indentation)
          sed -i 's/^          //' $PKG_DIR/DEBIAN/control

          # postinst
          cat > $PKG_DIR/DEBIAN/postinst <<'POSTINST'
          #!/bin/sh
          set -e
          if command -v gtk-update-icon-cache >/dev/null 2>&1; then
              gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
          fi
          if command -v update-desktop-database >/dev/null 2>&1; then
              update-desktop-database /usr/share/applications 2>/dev/null || true
          fi
          POSTINST
          sed -i 's/^          //' $PKG_DIR/DEBIAN/postinst
          chmod 755 $PKG_DIR/DEBIAN/postinst

          # postrm
          cat > $PKG_DIR/DEBIAN/postrm <<'POSTRM'
          #!/bin/sh
          set -e
          if [ "$1" = "remove" ] || [ "$1" = "purge" ]; then
              if command -v gtk-update-icon-cache >/dev/null 2>&1; then
                  gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
              fi
              if command -v update-desktop-database >/dev/null 2>&1; then
                  update-desktop-database /usr/share/applications 2>/dev/null || true
              fi
          fi
          POSTRM
          sed -i 's/^          //' $PKG_DIR/DEBIAN/postrm
          chmod 755 $PKG_DIR/DEBIAN/postrm

          # Build the .deb
          dpkg-deb --build $PKG_DIR ${PACKAGE_NAME}.deb
          dpkg-deb --info ${PACKAGE_NAME}.deb
          sha256sum ${PACKAGE_NAME}.deb > ${PACKAGE_NAME}.deb.sha256

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-debian${{ matrix.debian }}
          path: |
            *.deb
            *.sha256
          retention-days: 1

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: package

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          if [[ "$VERSION" == *"-"* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare release assets
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p release-assets

          cp artifacts/binary-debian12/${{ env.APP_NAME }} release-assets/${{ env.APP_NAME }}-${VERSION}-debian12-linux-amd64
          cp artifacts/binary-debian13/${{ env.APP_NAME }} release-assets/${{ env.APP_NAME }}-${VERSION}-debian13-linux-amd64

          cp artifacts/package-debian12/*.deb release-assets/
          cp artifacts/package-debian12/*.sha256 release-assets/
          cp artifacts/package-debian13/*.deb release-assets/
          cp artifacts/package-debian13/*.sha256 release-assets/

          cd release-assets
          sha256sum ${{ env.APP_NAME }}-${VERSION}-debian12-linux-amd64 > ${{ env.APP_NAME }}-${VERSION}-debian12-linux-amd64.sha256
          sha256sum ${{ env.APP_NAME }}-${VERSION}-debian13-linux-amd64 > ${{ env.APP_NAME }}-${VERSION}-debian13-linux-amd64.sha256
          cat *.sha256 > SHA256SUMS.txt

          echo "Release assets:"
          ls -la

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: OpenVPN3 Manager v${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ steps.version.outputs.prerelease }}
          generate_release_notes: true
          files: |
            release-assets/*.deb
            release-assets/*-linux-amd64
            release-assets/SHA256SUMS.txt
          body: |
            ## Installation

            ### Debian 12 (Bookworm)
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.APP_NAME }}_${{ steps.version.outputs.version }}_debian12_amd64.deb
            sudo dpkg -i ${{ env.APP_NAME }}_${{ steps.version.outputs.version }}_debian12_amd64.deb
            sudo apt-get install -f  # Install any missing dependencies
            ```

            ### Debian 13 (Trixie)
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.APP_NAME }}_${{ steps.version.outputs.version }}_debian13_amd64.deb
            sudo dpkg -i ${{ env.APP_NAME }}_${{ steps.version.outputs.version }}_debian13_amd64.deb
            sudo apt-get install -f  # Install any missing dependencies
            ```

            ### Verify Download
            ```bash
            sha256sum -c SHA256SUMS.txt
            ```

            ---
